---
title: "Delfina take-home assessment"
author: "Leonardo Hernandez Espinoza"
date: "2022-07-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
library(formattable)
```

## Import the data

```{r}
# If you are testing this outside my repo, please change the url
data_url <- "~/R/delfina-ds-interview/data/birthdata2020.csv"
birth_data <- read.csv(data_url, header = TRUE)
```

## Task 1:  What is the proportion of births by gestational age at delivery
I am answering this question as the proportion of births at each one of the combined gestation weeks based on the column COMBGEST.

Given that COMBGEST uses the value 99 as a filler value to denote missing data I will remove that value. 
I am also filtering the data to limit the results to values between 20 and 50 weeks, that range was selected based on information found [here](https://www.health.ny.gov/community/pregnancy/why_is_40_weeks_so_important.htm#:~:text=How%20long%20is%20full%20term%3F).

```{r}
birth_data %>% 
  filter(COMBGEST %in% (20:50)) %>% 
  ggplot(aes(COMBGEST))+
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = 'blue') +
  theme_classic()+
  xlab("Number of weeks at birth")+
  ylab("Proportion of births")
```
<br>
As we can see, the largest proportion of births occur between 39 and 41 weeks of gestation.


## Task 2:  What is the prevalence of preterm birth in this dataset?
To answer this question I will create a flag variable (is_preterm) to indicate if the birth occurred prior to 37 weeks of gestation (based on COMBGEST). In order to better calculate the proportion of preterm birth that occurred during 2020, I will exclude those cases where <br>COMBGEST =99.

From this point on, the is_preterm column will be used multiple times so I will fist add it to the data set.
```{r}
birth_data <- birth_data %>% 
  filter(COMBGEST != 99) %>% 
  mutate(is_preterm = case_when(
    COMBGEST < 37 ~ "Yes",
    TRUE ~ "No"
  ))


```
With the new column added, I then evaluate the proportions of preterm births
```{r}
 task2_table <- birth_data %>% 
  group_by(is_preterm) %>% 
  summarise(n_cases = n()) %>%
  mutate(percentage = 100* round(n_cases / sum(n_cases), 4)) %>% 
  data.table()
```
I will use the formattable package for better aesthetics 
```{r}
formattable(task2_table)
```

We can see that from all the observations in the data set, less ~12% of the cases are preterm births.

## Tast 3: Summarizes the relationship between preterm birth and the following four variables:

  - Maternal age (MAGER)

  - Maternal race/Hispanic origin (MRACEHISP)

  - Previous preterm birth (RF_PPTERM)

  - Total number of prenatal visits (PREVIS)


Based on the example given, I will compare the number of births (preterm and not) across the four variables listed above.

I will create dummy categorical variables to create bins for Maternal age (MAGER) and for the total number or prenatal visits (PREVIS). By creating bins I will aggregate those variables into fewer categorical values that would contain more observations and therefore will help focus the message in the data. 

First I will create the bins for Maternal Age:
```{r }
MAGER_cuts <- c(0,19,20,30,40,50)
MAGER_labs <- c("< 19", "20-29", "30-39", "40-49", "> 50")

birth_data <- birth_data %>% 
  mutate(age_bins = cut(MAGER, breaks=MAGER_cuts, labels=MAGER_labs ))
```


To create the bins for the total number or prenatal visits (PREVIS) I will first replace the value 99 that was used as a code signifying an unknown number of visits with NA. This way those observations will not be binned.

To define the bins I created a series of histograms to visualize the distribution of the observations and inform my decision (for more details see the sandbox file)

```{r}
PREVIS_cuts <- c(0,5,10,15,100)
PREVIS_labels <- c("< 5", "5-9",
                   "10-14", "> 15")

birth_data <- birth_data %>% 
  mutate(PREVIS = na_if(PREVIS, 99)) %>% 
  mutate(PREVIS_bins = cut(PREVIS, breaks =PREVIS_cuts, right=FALSE, labels=PREVIS_labels))
```

After creating the new features I can now summarize the number of births (preterm or not) for each category of the following variables:

- age_bins
- MRACEHISP
- RF_PPTERM
- PREVIS_bins


```{r}
birth_data %>% 
  group_by(age_bins ) %>% 
  count(is_preterm)
```

```{r}
birth_data %>% 
  group_by(is_preterm, age_bins) %>% 
  tally() %>% 
  spread(is_preterm, n)
```

